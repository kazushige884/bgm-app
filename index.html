<script>
/* ============================================================
 *  最小構成の「確実に鳴る」試聴プレイヤー
 *  - ページに <audio id="bgmPlayer"> を1つだけ作成
 *  - 「試聴」ボタン（data-id / data-key / data-preview に音声ID）のクリックで再生
 *  - geturl → download の順にURL取得（どちらでも再生可）
 *  - iOS/Safariの自動再生ブロックを避けるため、ユーザー操作内で再生
 * ============================================================ */

(() => {
  // ---------- 1) 共有プレイヤーを1つだけ作る ----------
  let player = document.getElementById('bgmPlayer');
  if (!player) {
    player = document.createElement('audio');
    player.id = 'bgmPlayer';
    player.preload = 'none';
    player.playsInline = true; // iOS用
    player.controls = true;    // まずは確実に鳴らすため操作UIを表示
    player.style.display = 'block';
    player.style.width = '100%';
    player.style.maxWidth = '520px';
    player.style.margin = '12px auto';
    document.body.appendChild(player);
  }

  // 便利: どこからでも再生できるユーティリティ（必要なら使えます）
  window.playBgmById = async function(id) {
    if (!id) throw new Error('id is required');
    let url = '';
    // まず geturl（署名付きURLがあればそれを、無ければ後述のフォールバック）
    try {
      const res = await fetch(`/.netlify/functions/geturl?id=${encodeURIComponent(id)}`, { credentials:'include' });
      if (!res.ok) throw new Error('geturl http ' + res.status);
      const data = await res.json();
      if (!data.ok || !data.url) throw new Error('geturl bad payload');
      url = data.url;
    } catch {
      url = `/.netlify/functions/download?id=${encodeURIComponent(id)}`; // フォールバック
    }
    // キャッシュつぶし（古いソースが残る対策）
    const bust = (url.includes('?') ? '&' : '?') + 'v=' + Date.now();

    player.pause();
    player.src = url + bust;
    player.currentTime = 0;
    await player.play(); // ユーザー操作内から呼ばれる前提
  };

  // ---------- 2) 試聴ボタンクリックを拾う ----------
  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('[data-id],[data-key],[data-preview],.btn-preview');
    if (!btn) return;

    // 「試聴」っぽいボタン以外の誤爆を減らす（必要なら緩めてもOK）
    const label = (btn.textContent || '').trim();
    if (!label.includes('試聴') && !btn.classList.contains('btn-preview')) return;

    const id = btn.dataset.id || btn.dataset.key || btn.dataset.preview;
    if (!id) {
      alert('音声IDが見つかりません（data-id が不足）');
      return;
    }

    try {
      // 見た目フィードバック
      const original = btn.textContent;
      btn.disabled = true;
      btn.textContent = '▶ 再生中…';

      await window.playBgmById(id);

      // 再生が止まったらボタンを戻す
      const reset = () => { btn.disabled = false; btn.textContent = original; };
      player.onpause = reset;
      player.onended = reset;

    } catch (err) {
      const name = (err && err.name) || '';
      const msg  = (err && err.message) || String(err);
      // iOSの「ユーザー操作外」のブロック
      if (name === 'NotAllowedError' || name === 'AbortError') {
        alert('再生がブロックされました。\n・端末の音量／消音スイッチをご確認ください\n・すぐもう一度「試聴」を押してください');
      } else {
        alert('再生に失敗しました：' + msg);
      }
      try { btn.disabled = false; btn.textContent = '試聴'; } catch {}
    }
  });

  // ---------- 3) 既にある一覧から data-id が取れるか簡易チェック ----------
  // （必要に応じて、ここで各行に data-id を自動で付与する処理を追加できます）
  // 例：タイトル列に "audio/…mp3" が入っているなら次のように拾えます。
  // document.querySelectorAll('button.btn-preview').forEach(btn => {
  //   if (!btn.dataset.id) {
  //     const row = btn.closest('tr');
  //     const titleCellText = row?.querySelector('td')?.textContent || '';
  //     const m = titleCellText.match(/audio\/[^\s]+\.mp3/);
  //     if (m) btn.dataset.id = m[0];
  //   }
  // });

})();
</script>