<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BGM 管理</title>
<style>
  :root{
    --bg:#ffffff; --text:#111; --panel:#f5f7fa; --line:#e3e6ea; --blue:#2563eb; --red:#e11d48;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  .wrap{max-width:min(1000px,92vw);margin:24px auto;padding:16px}
  h1{margin:0 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .btn{border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff}
  .btn.danger{background:var(--red);color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--line);color:#111}
  input[type="file"]{padding:8px;background:#fff;border:1px solid var(--line);border-radius:10px}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
  th{background:#fafbfc;font-weight:700}
  tbody tr:hover{background:#f9fbff}
  .num{font-variant-numeric:tabular-nums}
  .right{text-align:right}
  .center{text-align:center}
  .muted{color:#6b7280}
  .note{font-size:12px;color:#6b7280;margin-top:8px}
  .hidden{display:none !important}
  .player-wrap{margin:16px 0}
  .status{margin-top:10px;font-size:14px;color:#374151}
  .error{color:#b91c1c}
</style>
</head>
<body>
  <div class="wrap">
    <h1>BGMリスト</h1>

    <div class="card">
      <div class="toolbar">
        <input id="fileInput" type="file" accept="audio/*" />
        <button id="btnAdd" class="btn primary">追加</button>
        <button id="btnDelete" class="btn danger">削除</button>
        <span id="msg" class="status"></span>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th class="center" style="width:48px"><input id="chkAll" type="checkbox" /></th>
            <th>Title</th>
            <th style="width:200px">DATE</th>
            <th style="width:140px" class="right">FILESIZE</th>
            <th style="width:120px" class="center">DURATION</th>
            <th style="width:120px" class="center">操作</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="center muted">読み込み中…</td></tr>
        </tbody>
      </table>

      <div class="note">
        ・「追加」で音声（MP3 等）をアップロードします。<br/>
        ・「削除」はチェックした行を削除します。<br/>
        ・「試聴」は行の <b>data-id</b> を使って確実に再生します（署名URL→フォールバック）。<br/>
      </div>

      <div class="player-wrap">
        <audio id="bgmPlayer" controls preload="none" playsinline style="width:100%;max-width:560px;display:block;margin:0 auto"></audio>
      </div>

      <div id="err" class="status error hidden"></div>
    </div>
  </div>

<script>
/* ========== 共通ユーティリティ ========== */
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const setMsg = (t, isErr=false)=>{ const m=$('#msg'); if(!m)return; m.textContent=t||''; m.classList.toggle('error',!!isErr); };
const showErr=(t)=>{ const e=$('#err'); if(!e)return; e.textContent=t||''; e.classList.toggle('hidden',!t); };

const fmtSize=(n)=>{ const v=Number(n); if(!isFinite(v)||v<=0)return '—'; if(v>=1e9)return(v/1e9).toFixed(2)+' GB'; if(v>=1e6)return(v/1e6).toFixed(1)+' MB'; if(v>=1e3)return Math.round(v/1e3)+' KB'; return v+' B'; };
const fmtDate=(iso)=>{ try{ if(!iso)return '—'; const d=new Date(iso); if(isNaN(d))return '—'; const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }catch{return '—';}};
const fmtTime=(sec)=>{const s=Math.max(0,Math.floor(sec||0));const m=Math.floor(s/60),r=s%60;return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;};
const escapeHtml=(s)=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ========== 再生URL取得 ========== */
const player=$('#bgmPlayer');
async function getPlayableUrlById(id){
  try{
    const r=await fetch(`/.netlify/functions/geturl?id=${encodeURIComponent(id)}`,{credentials:'include'});
    if(!r.ok)throw new Error('geturl '+r.status);
    const js=await r.json();
    if(js&&js.ok&&js.url)return js.url;
  }catch{}
  return `/.netlify/functions/download?id=${encodeURIComponent(id)}`;
}

/* ========== size/date の穴埋め ========== */
async function fillMetaByHead(id,tds){
  try{
    const url=await getPlayableUrlById(id);
    const resp=await fetch(url,{headers:{Range:'bytes=0-0'},credentials:'include'});
    if(!resp.ok)throw new Error('head '+resp.status);

    // サイズ
    const cr=resp.headers.get('content-range')||''; let total=0; const m=cr.match(/\/(\d+)$/); if(m) total=Number(m[1]);
    if(!total) total=Number(resp.headers.get('content-length')||0);
    if(tds.size) tds.size.textContent= total? fmtSize(total):'—';

    // 日付（Last-Modified 優先、なければ Date ヘッダ）
    let lm=resp.headers.get('last-modified'); if(!lm) lm=resp.headers.get('date');
    if(tds.date) tds.date.textContent=lm? fmtDate(lm):'—';
  }catch{
    if(tds.size) tds.size.textContent='—';
    if(tds.date) tds.date.textContent='—';
  }
}

/* ========== 再生 ========== */
async function playBgmById(id,btn){
  if(!id)return;
  try{
    setMsg('音源URL取得中…');
    const url=await getPlayableUrlById(id);
    const bust=(url.includes('?')?'&':'?')+'v='+Date.now();
    player.pause(); player.src=url+bust; await player.play();
    setMsg('再生中');
    if(btn){const orig=btn.textContent;btn.disabled=true;btn.textContent='▶ 再生中…';const reset=()=>{btn.disabled=false;btn.textContent=orig};player.addEventListener('pause',reset,{once:true});player.addEventListener('ended',reset,{once:true});}
  }catch(err){const name=err?.name||'',msg=err?.message||String(err); if(name==='NotAllowedError'||name==='AbortError'){showErr('再生がブロックされました。端末の音量/消音を確認し再試行してください');}else{showErr('再生に失敗:'+msg);} }
}

/* ========== duration 計測 ========== */
async function probeDuration(id,td){
  try{
    const url=await getPlayableUrlById(id);
    const bust=(url.includes('?')?'&':'?')+'v='+Date.now();
    const a=new Audio();a.preload='metadata';a.src=url+bust;
    await new Promise((res,rej)=>{a.onloadedmetadata=()=>res();a.onerror=()=>rej();});
    if(td) td.textContent=isFinite(a.duration)?fmtTime(a.duration):'—';
  }catch{if(td) td.textContent='—';}
}

/* ========== 一覧ロード ========== */
async function loadList(){
  showErr(''); setMsg('一覧を取得中…');
  const tbody=$('#tbody'); tbody.innerHTML='<tr><td colspan="6" class="center muted">読み込み中…</td></tr>';
  try{
    const r=await fetch('/.netlify/functions/list',{credentials:'include'});
    if(!r.ok)throw new Error('list '+r.status);
    const js=await r.json(); if(!(js&&js.ok&&Array.isArray(js.items))) throw new Error('bad payload');
    const items=js.items;
    if(items.length===0){tbody.innerHTML='<tr><td colspan="6" class="center muted">ファイルはありません</td></tr>'; setMsg('OK'); return;}
    const frag=document.createDocumentFragment();
    items.forEach(it=>{
      const id=it.id||it.key||''; const name=decodeURIComponent((id.split('/').pop()||'').replace(/\+/g,' ')); const title=it.title||name;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="center"><input type="checkbox" class="rowchk" data-id="${id}"></td>
        <td>${escapeHtml(title)}</td>
        <td class="num td-date">${fmtDate(it.date)}</td>
        <td class="right num td-size">${fmtSize(it.size)}</td>
        <td class="center num"><span class="dur">--:--</span></td>
        <td class="center"><button class="btn ghost btn-preview" data-id="${id}">試聴</button></td>`;
      frag.appendChild(tr);

      probeDuration(id,tr.querySelector('.dur'));
      if(!it.size||!it.date){ fillMetaByHead(id,{size:tr.querySelector('.td-size'),date:tr.querySelector('.td-date')}); }
    });
    tbody.innerHTML=''; tbody.appendChild(frag); setMsg(`OK(${items.length}件)`);
  }catch(err){tbody.innerHTML='<tr><td colspan="6" class="center error">一覧取得に失敗</td></tr>'; showErr(err.message);}
}

/* ========== 追加/削除/イベント ========== */
$('#btnAdd').addEventListener('click',async()=>{const f=$('#fileInput').files?.[0];if(!f){alert('ファイルを選択');return;}
  try{setMsg('アップロード中…');const fd=new FormData();fd.append('file',f);const r=await fetch('/.netlify/functions/upload',{method:'POST',body:fd});const js=await r.json();if(!js.ok)throw new Error('upload error');$('#fileInput').value='';await loadList();}catch(e){showErr('アップロード失敗:'+e.message);}
});
$('#btnDelete').addEventListener('click',async()=>{const ids=$$('#tbody .rowchk:checked').map(c=>c.dataset.id);if(!ids.length){alert('削除対象なし');return;} if(!confirm(`${ids.length}件削除?`))return;
  try{setMsg('削除中…');const r=await fetch('/.netlify/functions/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids})});const js=await r.json();if(!js.ok)throw new Error('remove error');await loadList();}catch(e){showErr('削除失敗:'+e.message);}
});
document.addEventListener('click',ev=>{const btn=ev.target.closest('.btn-preview');if(btn)playBgmById(btn.dataset.id,btn);});
$('#chkAll').addEventListener('change',e=>{$$('#tbody .rowchk').forEach(c=>c.checked=e.target.checked);});

/* 初期ロード */
loadList();
</script>
</body>
</html>