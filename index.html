<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BGM 管理</title>
<style>
  :root{
    --bg:#fafafa; --card:#fff; --text:#222; --muted:#777; --line:#e6e6e6;
    --primary:#2563eb; --danger:#e11d48;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  .container{max-width:960px;margin:40px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{font-size:28px;margin:0 0 16px}
  h2{font-size:20px;margin:0 0 12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border-radius:10px;border:1px solid var(--line);padding:10px 16px;font-weight:700;cursor:pointer;background:#f7f7f7}
  .btn.primary{background:#eef2ff;border-color:#c7d2fe;color:#111}
  .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
  .btn.ghost{background:#fff}
  .right{margin-left:auto}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);padding:12px 8px;text-align:left;vertical-align:middle}
  .table th{font-size:14px;color:#555;background:#f9fafb}
  .muted{color:var(--muted);font-size:12px}
  .pill{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--line);border-radius:10px;width:36px;height:36px;background:#fff;cursor:pointer}
  .badge{display:inline-block;padding:2px 8px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:12px;color:#444}
  .err{color:#b91c1c;white-space:pre-wrap;word-break:break-all;margin-top:10px}
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .hidden{display:none !important}
  .topbar{display:flex;align-items:center;gap:10px;margin-bottom:12px}
</style>
</head>
<body>
<div class="container">
  <h1>BGM 管理</h1>

  <!-- メインカード -->
  <div class="card">
    <div class="topbar">
      <div class="badge">左上</div>
      <h2 style="margin:0">BGMリスト</h2>
      <div class="right">
        <button id="btnBack" class="btn">戻る</button>
      </div>
    </div>

    <table class="table" aria-label="BGM一覧">
      <thead>
        <tr>
          <th style="width:44px"><input type="checkbox" id="chkAll" /></th>
          <th>Title</th>
          <th style="width:140px">date</th>
          <th style="width:120px">filesize</th>
          <th style="width:100px">duration</th>
          <th style="width:80px">試聴</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="muted" id="countText">0 件</div>

    <div class="toolbar">
      <input id="filePicker" type="file" accept="audio/*" class="hidden" />
      <button id="btnAdd" class="btn primary">追加</button>
      <button id="btnDel" class="btn danger">削除</button>
    </div>

    <div id="errBox" class="err"></div>
  </div>
</div>

<script>
/* ========= ヘルパー ========= */
const $ = (id)=>document.getElementById(id);
const fmtBytes = (n)=>{
  if(!Number.isFinite(n) || n<=0) return '–';
  const u=['B','KB','MB','GB']; let i=0;
  while(n>=1024 && i<u.length-1){ n/=1024; i++; }
  return `${n.toFixed(n<10&&i>0?1:0)} ${u[i]}`;
};
const fmtDateISO = (s)=>{
  if(!s) return '–';
  const d = new Date(s);
  if(isNaN(d)) return '–';
  const z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}\n${z(d.getHours())}:${z(d.getMinutes())}`;
};
const parseDateFromKey = (key)=>{
  // key 例: audio/2025-08-24T081846564Z-xxxx.mp3 → 2025-08-24T08:18:46Z に整形
  const m = String(key).match(/^audio\/([^/-]+)/);
  if(!m) return null;
  const raw = m[1];
  const m2 = raw.match(/^(\d{4}-\d{2}-\d{2})T(\d{2})(\d{2})(\d{2})/);
  return m2 ? `${m2[1]}T${m2[2]}:${m2[3]}:${m2[4]}Z` : null;
};

/* ========= API ========= */
async function apiList(){
  const r = await fetch('/.netlify/functions/list', { method:'GET' });
  if(!r.ok) throw new Error(`一覧の取得に失敗しました（HTTP ${r.status}）\n${await r.text()}`);
  return r.json();
}
async function apiUpload(file){
  const fd = new FormData();
  fd.append('file', file);
  const r = await fetch('/.netlify/functions/upload', { method:'POST', body: fd });
  if(!r.ok) throw new Error(`アップロード失敗（HTTP ${r.status}）\n${await r.text()}`);
  return r.json();
}
async function apiRemove(ids){
  const r = await fetch('/.netlify/functions/remove', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ ids })
  });
  if(!r.ok) throw new Error(`削除失敗（HTTP ${r.status}）\n${await r.text()}`);
  return r.json();
}

/* ========= UI：描画 ========= */
let items = []; // {id,title,url,size?,date?}

function setError(msg){ $('errBox').textContent = msg || ''; }
function setCount(){
  $('countText').textContent = `${items.length} 件`;
}
function makeRow(it){
  const tr = document.createElement('tr');

  const tdChk = document.createElement('td');
  const cb = document.createElement('input');
  cb.type = 'checkbox'; cb.dataset.id = it.id;
  tdChk.appendChild(cb);

  const tdTitle = document.createElement('td');
  tdTitle.textContent = it.title || it.id.split('/').pop();

  const tdDate = document.createElement('td');
  tdDate.style.whiteSpace='pre';
  const d = it.date || parseDateFromKey(it.id);
  tdDate.textContent = fmtDateISO(d);

  const tdSize = document.createElement('td');
  tdSize.textContent = fmtBytes(it.size);

  const tdDur = document.createElement('td');
  tdDur.textContent = '–:–';

  const tdPlay = document.createElement('td');
  const btn = document.createElement('button');
  btn.className = 'pill'; btn.title='1.5秒だけ試聴';
  btn.textContent = '▶';
  btn.addEventListener('click', ()=>{
    const a = new Audio(it.url);
    a.addEventListener('loadedmetadata', ()=>{
      if(Number.isFinite(a.duration)){
        const m=Math.floor(a.duration/60), s=Math.round(a.duration%60);
        tdDur.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }
    });
    a.play().catch(()=>{});
    setTimeout(()=>{ try{ a.pause(); }catch{} }, 1500);
  });
  tdPlay.appendChild(btn);

  tr.append(tdChk, tdTitle, tdDate, tdSize, tdDur, tdPlay);
  return tr;
}

function render(){
  const tbody = $('tbody');
  tbody.innerHTML = '';
  for(const it of items){
    tbody.appendChild(makeRow(it));
  }
  setCount();
}

/* ========= イベント ========= */
$('btnBack').addEventListener('click', ()=> history.back());
$('chkAll').addEventListener('change', (e)=>{
  const on = e.target.checked;
  document.querySelectorAll('#tbody input[type="checkbox"]').forEach(c=> c.checked = on);
});

$('btnAdd').addEventListener('click', ()=> $('filePicker').click());
$('filePicker').addEventListener('change', async (e)=>{
  setError('');
  const f = e.target.files && e.target.files[0];
  e.target.value = '';
  if(!f) return;
  try{
    const res = await apiUpload(f);
    if(res?.ok){
      // 即時反映：レスポンスに size/date を含めているのでそのまま利用
      items.unshift({
        id: res.id,
        title: res.title,
        url: res.url,
        size: res.size,
        date: res.date
      });
      render();
    }else{
      throw new Error(res?.errorMessage || 'アップロードに失敗しました');
    }
  }catch(err){
    setError(String(err));
  }
});

$('btnDel').addEventListener('click', async ()=>{
  setError('');
  const ids = Array.from(document.querySelectorAll('#tbody input[type="checkbox"]:checked'))
              .map(c=>c.dataset.id);
  if(ids.length===0){ setError('削除するファイルをチェックしてください'); return; }
  if(!confirm(`${ids.length} 件を削除します。よろしいですか？`)) return;

  try{
    const res = await apiRemove(ids);
    if(res?.ok){
      const set = new Set(ids);
      items = items.filter(it=> !set.has(it.id));
      render();
    }else{
      throw new Error(res?.errorMessage || '削除に失敗しました');
    }
  }catch(err){
    setError(String(err));
  }
});

/* ========= 初回ロード ========= */
(async function init(){
  setError('読み込み中…');
  try{
    const res = await apiList();
    if(res?.ok){
      items = Array.isArray(res.items) ? res.items : [];
      // 新しい順に（list関数でもソートしているが念のため）
      items.sort((a,b)=>{
        const ad = a.date || parseDateFromKey(a.id);
        const bd = b.date || parseDateFromKey(b.id);
        if(!ad && !bd) return 0;
        if(!ad) return 1;
        if(!bd) return -1;
        return ad < bd ? 1 : -1;
      });
      setError('');
      render();
    }else{
      throw new Error(res?.errorMessage || '一覧の取得に失敗しました');
    }
  }catch(err){
    setError(String(err));
  }
})();
</script>
</body>
</html>