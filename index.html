<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BGM 管理</title>
<style>
  :root{ --accent:#2563eb; --danger:#ef4444; }
  html,body{margin:0;padding:0;background:#fff;color:#111;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 16px;font-size:28px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .center{display:flex;flex-direction:column;align-items:center;gap:16px}
  .lead{font-size:18px;color:#374151}
  button{border:0;border-radius:10px;padding:12px 22px;font-weight:800;cursor:pointer}
  .primary{background:var(--accent);color:#fff}
  .ghost{background:#f3f4f6}
  .danger{background:#ef4444;color:#fff}
  .hidden{display:none}
  .right{margin-left:auto}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left}
  th{background:#f8fafc;font-weight:800}
  .toolbar{display:flex;align-items:center;gap:8px;position:sticky;bottom:16px;justify-content:flex-end;margin-top:12px}
  .muted{color:#6b7280;font-size:12px}
  .err{color:#ef4444;font-size:14px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>BGM 管理</h1>

  <!-- タイトル（開始ボタンだけ） -->
  <section id="view-title" class="card">
    <div class="center" style="min-height:28vh;justify-content:center">
      <div class="lead">このアプリではBGM（MP3）の追加・削除・試聴ができます。</div>
      <button id="btnStart" class="primary" style="font-size:18px">開始</button>
      <div id="titleNote" class="muted">※「開始」を押すとBGMリスト画面へ移動します。</div>
    </div>
  </section>

  <!-- リスト画面 -->
  <section id="view-list" class="card hidden">
    <div style="display:flex;align-items:center;gap:12px">
      <div>
        <div style="font-size:14px;color:#6b7280">左上</div>
        <div style="font-size:22px;font-weight:800">BGMリスト</div>
      </div>
      <button id="btnBack" class="ghost right">戻る</button>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:48px"><input type="checkbox" id="chkAll"></th>
          <th>Title</th>
          <th style="width:160px">date</th>
          <th style="width:120px">filesize</th>
          <th style="width:120px">duration</th>
          <th style="width:80px">試聴</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="toolbar">
      <input id="pick" type="file" accept="audio/*" class="hidden" multiple>
      <button id="btnAdd" class="ghost">追加</button>
      <button id="btnDel" class="danger">削除</button>
    </div>

    <div id="note" class="muted"></div>
    <div id="errMsg" class="err"></div>
  </section>
</div>

<script>
/* ====== ユーティリティ ====== */
const EL = id => document.getElementById(id);
const api = p => `/.netlify/functions/${p}`;

/* ====== 画面遷移 ====== */
function showTitle(){ EL('view-title').classList.remove('hidden'); EL('view-list').classList.add('hidden'); }
function showList(){ EL('view-title').classList.add('hidden'); EL('view-list').classList.remove('hidden'); }

/* ====== タイトル → リスト ====== */
EL('btnStart').addEventListener('click', ()=>{
  showList();
  list(); // そのまま一覧の読込を開始
});
EL('btnBack').addEventListener('click', ()=>{
  showTitle();
});

/* ====== 一覧取得と表示 ====== */
async function list(){
  EL('errMsg').textContent = '';
  EL('tbody').innerHTML = '<tr><td colspan="6" class="muted">読み込み中…</td></tr>';
  try{
    const res = await fetch(api('list'), { credentials:'include' });
    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      EL('tbody').innerHTML = '';
      EL('errMsg').textContent = `一覧の取得に失敗しました（HTTP ${res.status}） ${txt}`;
      return;
    }
    const { items=[] } = await res.json();
    render(items);
  }catch(e){
    EL('tbody').innerHTML = '';
    EL('errMsg').textContent = '通信エラー：' + e;
  }
}

function humanSize(n){ if(!n) return '0 B';
  const u=['B','KB','MB','GB']; let i=0; n=Number(n)||0;
  while(n>=1024 && i<u.length-1){ n/=1024; i++; }
  return `${n.toFixed(1)} ${u[i]}`;
}
function fmtDate(s){
  try{ const d=new Date(s);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }catch{ return s||''; }
}
function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

function render(items){
  const tb = EL('tbody'); tb.innerHTML='';
  for(const it of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${it.id}"></td>
      <td>${escapeHtml(it.title || it.id?.split('/').pop())}</td>
      <td>${fmtDate(it.date)}</td>
      <td>${humanSize(it.size)}</td>
      <td class="dur" data-url="${it.url||''}">--:--</td>
      <td><button class="ghost play" data-url="${it.url||''}">▶︎</button></td>
    `;
    tb.appendChild(tr);
  }

  // 全選択
  EL('chkAll').checked = false;
  EL('chkAll').onclick = ()=> tb.querySelectorAll('input[type=checkbox]').forEach(c=> c.checked = EL('chkAll').checked);

  // 試聴（1.5秒だけ）
  tb.querySelectorAll('button.play').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const url = btn.dataset.url; if(!url) return;
      const a = new Audio(url);
      a.play().catch(()=>{});
      setTimeout(()=>{ try{ a.pause(); a.currentTime=0; }catch{} }, 1500);
    });
  });

  // Duration（メタデータ読み）
  tb.querySelectorAll('td.dur').forEach(td=>{
    const url = td.dataset.url; if(!url) return;
    const a = new Audio(); a.src = url; a.preload='metadata';
    a.addEventListener('loadedmetadata', ()=>{
      const t = Math.floor(a.duration||0);
      const m = String(Math.floor(t/60)).padStart(2,'0');
      const s = String(t%60).padStart(2,'0');
      td.textContent = (t>0) ? `${m}:${s}` : '--:--';
    });
  });

  EL('note').textContent = `${items.length} 件`;
}

/* ====== 追加・削除 ====== */
EL('btnAdd').addEventListener('click', ()=> EL('pick').click());
EL('pick').addEventListener('change', async (e)=>{
  EL('errMsg').textContent = '';
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  try{
    for(const f of files){
      const fd = new FormData(); fd.append('file', f);
      const res = await fetch(api('upload'), { method:'POST', credentials:'include', body: fd });
      if(!res.ok){ const t=await res.text().catch(()=> ''); throw new Error(`アップロード失敗 (HTTP ${res.status}) ${t}`); }
    }
    EL('pick').value='';
    list();
  }catch(err){
    EL('errMsg').textContent = String(err);
  }
});

EL('btnDel').addEventListener('click', async ()=>{
  EL('errMsg').textContent = '';
  const ids = Array.from(EL('tbody').querySelectorAll('input[type=checkbox]:checked')).map(c=> c.dataset.id);
  if(!ids.length){ alert('削除する項目にチェックを入れてください'); return; }
  if(!confirm(`${ids.length} 件を削除しますか？`)) return;
  try{
    for(const id of ids){
      const res = await fetch(api('remove')+`?id=${encodeURIComponent(id)}`, { method:'DELETE', credentials:'include' });
      if(!res.ok){ const t=await res.text().catch(()=> ''); throw new Error(`削除失敗 (HTTP ${res.status}) ${t}`); }
    }
    list();
  }catch(err){
    EL('errMsg').textContent = String(err);
  }
});

/* 初期表示：タイトル */
showTitle();
</script>
</body>
</html>